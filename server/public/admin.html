<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shared Vault Admin</title>
    <style>
      :root {
        font-family: 'Segoe UI', system-ui, sans-serif;
        color: #e2e8f0;
        background: #030712;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #020617, #0f172a);
        min-height: 100vh;
      }
      .shell {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem;
      }
      h1, h2, h3 {
        margin: 0;
        color: #f8fafc;
      }
      p {
        margin: 0.2rem 0 0;
        color: #94a3b8;
      }
      .panel {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 18px;
        padding: 1.35rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 15px 40px rgba(2, 6, 23, 0.65);
      }
      .admin-layout {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: minmax(0, 1fr);
        align-items: stretch;
      }
      .admin-inner {
        display: grid;
        grid-template-columns: 220px minmax(0, 1fr);
        gap: 1.2rem;
      }
      .side-nav {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }
      .nav-btn {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.86);
        color: #f8fafc;
        padding: 0.65rem 1rem;
        text-align: left;
        font-size: 0.95rem;
        cursor: pointer;
        transition: border-color 0.2s ease, transform 0.2s ease;
      }
      .nav-btn:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
      .nav-btn.active {
        border-color: rgba(99, 102, 241, 0.9);
        transform: translateX(2px);
      }
      .admin-main {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .admin-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .admin-placeholder {
        padding: 1.2rem 1.4rem;
        border-radius: 14px;
        border: 1px dashed rgba(148, 163, 184, 0.5);
        color: #cbd5f5;
        background: rgba(15, 23, 42, 0.5);
      }
      }
      .sso-panel {
        border-left: 3px solid rgba(99, 102, 241, 0.8);
      }
      label {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #94a3b8;
        display: block;
        margin-bottom: 0.25rem;
      }
      input, textarea, select {
        width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(2, 6, 23, 0.9);
        color: #e2e8f0;
        padding: 0.6rem;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }
      textarea {
        min-height: 70px;
        resize: vertical;
      }
      button {
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        border-radius: 999px;
        padding: 0.6rem 1.2rem;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white;
        transition: transform 0.2s ease;
      }
      button:active {
        transform: translateY(1px);
      }
      .vault-list {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 1rem;
      }
      .vault-card {
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.75);
        cursor: pointer;
      }
      .vault-card.active {
        border-color: rgba(99, 102, 241, 0.8);
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4);
      }
      .members {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 0.5rem;
      }
      .member-chip {
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.15);
        border: 1px solid rgba(99, 102, 241, 0.3);
        font-size: 0.85rem;
      }
      .member-chip.viewer {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.4);
      }
      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .row > div {
        flex: 1;
      }
      .status {
        font-size: 0.8rem;
        color: #a5b4fc;
        min-height: 1.1rem;
      }
      .user-table {
        display: flex;
        flex-direction: column;
        gap: 0;
        margin-top: 0.5rem;
      }
      .user-row,
      .user-row-header {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1.2fr);
        gap: 0.75rem;
        padding: 0.55rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      }
      .user-row-header {
        font-weight: 600;
        color: #a5b4fc;
      }
      .user-row span {
        font-size: 0.95rem;
        color: #e2e8f0;
      }
      .audit-table {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-top: 0.5rem;
      }
      .audit-row,
      .audit-row-header {
        display: grid;
        grid-template-columns: 1fr minmax(0, 0.8fr) minmax(0, 1.2fr) minmax(0, 1.2fr);
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      }
      .audit-row-header {
        font-weight: 600;
        color: #a5b4fc;
      }
      .audit-row span {
        font-size: 0.9rem;
        color: #e2e8f0;
        word-break: break-word;
      }
      .member-grid {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      @media (max-width: 920px) {
        .admin-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  </head>
  <body>
    <div class="shell">
      <div id="root"></div>
    </div>
    <script>
      const { useState, useEffect } = React;

        const fetchJson = async (path, options = {}) => {
          const response = await fetch(path, options);
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload.error || 'Request failed');
          }
          return response.json();
        };

      const textEncoder = new TextEncoder();

      const arrayBufferToBase64 = (buffer) => {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        bytes.forEach((b) => (binary += String.fromCharCode(b)));
        return btoa(binary);
      };

      const base64ToArrayBuffer = (base64) => {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      };

      const randomBase64 = (length = 12) => {
        const bytes = new Uint8Array(length);
        crypto.getRandomValues(bytes);
        return arrayBufferToBase64(bytes);
      };

      const encryptJson = async (payload, key) => {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = textEncoder.encode(JSON.stringify(payload));
        const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
        return {
          ciphertext: arrayBufferToBase64(cipher),
          iv: arrayBufferToBase64(iv),
        };
      };

      const generateSharedKey = () => crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);

      const exportKeyBase64 = (key) => crypto.subtle.exportKey('raw', key).then((raw) => arrayBufferToBase64(raw));

      function App() {
        const [token, setToken] = useState('');
        const [vaults, setVaults] = useState([]);
        const [selected, setSelected] = useState(null);
        const [sessionUserId, setSessionUserId] = useState('');
        const [isEditingVault, setIsEditingVault] = useState(false);
        const [editName, setEditName] = useState('');
        const [editMembers, setEditMembers] = useState([]);
        const [status, setStatus] = useState('Paste a JWT and load shared vaults.');
        const [name, setName] = useState('');
        const [members, setMembers] = useState([{ userId: '', role: 'member' }]);
        const [loginUsername, setLoginUsername] = useState('');
        const [loginPassword, setLoginPassword] = useState('');
        const [loginLoading, setLoginLoading] = useState(false);
        const [msClientId, setMsClientId] = useState('');
        const [msTenantId, setMsTenantId] = useState('common');
        const msSsoWindowRef = React.useRef(null);
        const [msClientSecret, setMsClientSecret] = useState('');
        const [msClientSecretSet, setMsClientSecretSet] = useState(false);
        const [usersList, setUsersList] = useState([]);
        const [usersLoading, setUsersLoading] = useState(false);
        const [usersError, setUsersError] = useState('');
        const [activeSection, setActiveSection] = useState('vault');
        const [auditEntries, setAuditEntries] = useState([]);
        const [auditLoading, setAuditLoading] = useState(false);
        const [auditError, setAuditError] = useState('');

        const headers = token ? { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };

        useEffect(() => {
          if (token) {
            loadVaults();
          }
        }, [token]);

        useEffect(() => {
          const loadConfig = async () => {
            try {
              const payload = await fetchJson('/admin/config');
              setMsClientId(payload.msClientId ?? '');
              setMsTenantId(payload.msTenantId ?? 'common');
              setMsClientSecretSet(Boolean(payload.msClientSecretSet));
              setMsClientSecret('');
            } catch (err) {
              setStatus(err.message);
            }
          };
          loadConfig();
        }, []);

        useEffect(() => {
          if (!token && ['sso', 'users', 'audit'].includes(activeSection)) {
            setActiveSection('vault');
          }
        }, [token, activeSection]);

        useEffect(() => {
          if (activeSection === 'users' && token) {
            loadUsers();
          }
        }, [activeSection, token]);

        useEffect(() => {
          if (activeSection === 'audit' && token) {
            loadAudit();
          }
        }, [activeSection, token]);

        useEffect(() => {
          if (activeSection === 'users' && token) {
            loadUsers();
          }
        }, [activeSection, token]);

        useEffect(() => {
          const handleMsMessage = (event) => {
            if (event.origin !== window.location.origin) {
              return;
            }
            if (!event.data || event.data.type !== 'ms-sso') {
              return;
            }
            if (msSsoWindowRef.current && !msSsoWindowRef.current.closed) {
              msSsoWindowRef.current.close();
            }
            msSsoWindowRef.current = null;

            if (event.data.error) {
              setStatus(event.data.error);
              return;
            }

            const { token: msToken, user: msUser } = event.data;
            if (!msToken || !msUser) {
              setStatus('Microsoft sign-in failed');
              return;
            }

            setLoginUsername(msUser.username ?? '');
            setLoginPassword('');
            setSessionUserId(msUser.id ?? '');
            setToken(msToken);
            setStatus(`Logged in as ${msUser.username ?? 'Microsoft user'}`);
          };

          window.addEventListener('message', handleMsMessage);
          return () => {
            window.removeEventListener('message', handleMsMessage);
            if (msSsoWindowRef.current && !msSsoWindowRef.current.closed) {
              msSsoWindowRef.current.close();
            }
          };
        }, []);

        const handleLogin = async () => {
          if (!loginUsername.trim() || !loginPassword) {
            setStatus('Provide username and password to log in.');
            return;
          }

          setLoginLoading(true);
          setStatus('Logging in...');
          try {
            const payload = await fetchJson('/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: loginUsername.trim(),
                password: loginPassword,
              }),
            });
            setToken(payload.token);
            setStatus(`Logged in as ${payload.user?.username ?? loginUsername.trim()}`);
            setLoginPassword('');
            setSessionUserId(payload.user?.id ?? '');
          } catch (err) {
            setStatus(err.message);
          } finally {
            setLoginLoading(false);
          }
        };

        const handleSaveConfig = async () => {
          try {
            const payload = {
              msClientId: msClientId.trim() || '',
              msTenantId: msTenantId.trim() || '',
            };
            if (msClientSecret.trim()) {
              payload.msClientSecret = msClientSecret.trim();
            }
            const response = await fetchJson(
              '/admin/config',
              {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'application/json' },
              }
            );
            setMsClientSecret('');
            setMsClientSecretSet(Boolean(response.msClientSecretSet));
            setStatus('SSO settings saved');
          } catch (err) {
            setStatus(err.message);
          }
        };

        const handleResetConfig = async () => {
          try {
            const response = await fetchJson(
              '/admin/config',
              {
                method: 'POST',
                body: JSON.stringify({ msClientId: '', msTenantId: '', clearMsClientSecret: true }),
                headers: { 'Content-Type': 'application/json' },
              }
            );
            setMsClientId('');
            setMsTenantId('common');
            setMsClientSecret('');
            setMsClientSecretSet(Boolean(response.msClientSecretSet));
            setStatus('SSO settings cleared');
          } catch (err) {
            setStatus(err.message);
          }
        };

        const handleClearSecret = async () => {
          if (!msClientSecretSet) {
            setStatus('No client secret stored');
            return;
          }
          try {
            const response = await fetchJson(
              '/admin/config',
              {
                method: 'POST',
                body: JSON.stringify({ clearMsClientSecret: true }),
                headers: { 'Content-Type': 'application/json' },
              }
            );
            setMsClientSecret('');
            setMsClientSecretSet(Boolean(response.msClientSecretSet));
            setStatus('Client secret cleared');
          } catch (err) {
            setStatus(err.message);
          }
        };

        const loadVaults = async () => {
          if (!token) {
            setStatus('JWT required');
            return;
          }
          setStatus('Loading shared vaults...');
          try {
            const payload = await fetchJson('/shared-vaults', { headers });
            setVaults(payload.sharedVaults || []);
            setStatus('Vaults loaded.');
          } catch (err) {
            setStatus(err.message);
          }
        };

        const loadUsers = async () => {
          if (!token) {
            setUsersList([]);
            return;
          }
          setUsersLoading(true);
          setUsersError('');
          try {
            const payload = await fetchJson('/admin/users', { headers });
            setUsersList(payload.users || []);
          } catch (err) {
            setUsersError(err.message);
          } finally {
            setUsersLoading(false);
          }
        };

        const loadAudit = async () => {
          if (!token) {
            setAuditEntries([]);
            setAuditError('');
            return;
          }
          setAuditLoading(true);
          setAuditError('');
          try {
            const payload = await fetchJson('/admin/audit', { headers });
            setAuditEntries(payload.logs || []);
          } catch (err) {
            setAuditError(err.message);
          } finally {
            setAuditLoading(false);
          }
        };

        const createEditMember = (member = {}) => ({
          identifier: member.identifier ?? member.userId ?? '',
          role: member.role ?? 'member',
          status: member.status ?? 'active',
        });

        const addEditMember = () => {
          setEditMembers((prev) => [...prev, createEditMember()]);
        };

        const updateEditMember = (index, field, value) => {
          setEditMembers((prev) =>
            prev.map((member, idx) => (idx === index ? { ...member, [field]: value } : member))
          );
        };

        const removeEditMember = (index) => {
          setEditMembers((prev) => prev.filter((_, idx) => idx !== index));
        };

        const handleSaveVaultChanges = async () => {
          if (!selected) {
            return;
          }

          if (!editName.trim()) {
            setStatus('Vault name is required');
            return;
          }

          const memberWrappers = editMembers
            .map((member) => ({
              userId: member.identifier.trim(),
              role: member.role,
              status: member.status,
            }))
            .filter((member) => member.userId);

          try {
            await fetchJson(
              `/shared-vaults/${selected.id}`,
              {
                method: 'PATCH',
                headers,
                body: JSON.stringify({
                  name: editName.trim(),
                  memberWrappers,
                }),
              }
            );
            setStatus('Shared vault updated');
            setIsEditingVault(false);
            await loadVaults();
            await selectVault(selected.id);
          } catch (err) {
            setStatus(err.message);
          }
        };

        const handleDeleteVault = async () => {
          if (!selected) {
            return;
          }

          if (!confirm(`Delete vault "${selected.name}" permanently?`)) {
            return;
          }

          try {
            await fetchJson(`/shared-vaults/${selected.id}`, {
              method: 'DELETE',
              headers,
            });
            setStatus('Shared vault deleted');
            setSelected(null);
            setIsEditingVault(false);
            await loadVaults();
          } catch (err) {
            setStatus(err.message);
          }
        };

        const selectVault = async (vaultId) => {
          if (!token) return;
          setStatus('Loading vault...');
          try {
            const payload = await fetchJson(`/shared-vaults/${vaultId}`, { headers });
            setSelected(payload.vault);
            setIsEditingVault(false);
            setEditName(payload.vault?.name ?? '');
            setEditMembers(payload.vault?.members ?? []);
            setStatus(`Vault "${payload.vault.name}" loaded.`);
          } catch (err) {
            setStatus(err.message);
          }
        };

        const updateMember = (index, field, value) => {
          setMembers((prev) => prev.map((member, idx) => (idx === index ? { ...member, [field]: value } : member)));
        };

        const addMember = () => setMembers((prev) => [...prev, { userId: '', role: 'member' }]);

        const createVault = async () => {
          if (!name.trim()) {
            setStatus('Vault name is required.');
            return;
          }
          if (!token) {
            setStatus('JWT required.');
            return;
          }
          if (!members.some((member) => member.userId.trim())) {
            setStatus('At least one member is required.');
            return;
          }

          const sharedKey = await generateSharedKey();
          const sharedKeyBase64 = await exportKeyBase64(sharedKey);
          const encryptedPayload = await encryptJson([], sharedKey);

          const wrappers = members
            .filter((member) => member.userId.trim())
            .map((member) => ({
              userId: member.userId.trim(),
              wrappedKey: sharedKeyBase64,
              role: member.role,
              status: 'active',
              invitedBy: 'admin-ui',
            }));
          if (!wrappers.length) {
            setStatus('At least one member is required.');
            return;
          }
          const payload = {
            name: name.trim(),
            encryptedVault: encryptedPayload.ciphertext,
            iv: encryptedPayload.iv,
            salt: sharedKeyBase64,
            memberWrappers: wrappers,
          };
          try {
            await fetchJson('/shared-vaults', {
              method: 'POST',
              headers,
              body: JSON.stringify(payload),
            });
            setStatus('Shared vault created. Reloading...');
            setName('');
            setMembers([{ userId: '', role: 'member' }]);
            await loadVaults();
          } catch (err) {
            setStatus(err.message);
          }
        };

        const handleLogout = () => {
          setToken('');
          setVaults([]);
          setSelected(null);
          setSessionUserId('');
          setStatus('Signed out');
        };

        const startMsSso = () => {
          if (!msClientId.trim()) {
            setStatus('Configure Microsoft SSO first');
            return;
          }
          if (msSsoWindowRef.current && !msSsoWindowRef.current.closed) {
            msSsoWindowRef.current.focus();
            return;
          }
          const popup = window.open('/sso/ms/start', 'admin-ms-sso', 'width=500,height=700');
          if (!popup) {
            setStatus('Allow popups to use Microsoft sign-in');
            return;
          }
          msSsoWindowRef.current = popup;
          setStatus('Signing in with Microsoft…');
        };

        const sessionPanel = React.createElement(
          'div',
          { className: 'panel' },
          React.createElement('h2', null, 'Session'),
          React.createElement('p', null, 'JWT captured automatically.'),
          React.createElement('textarea', {
            rows: 3,
            readOnly: true,
            value: token,
          }),
          React.createElement(
            'button',
            {
              type: 'button',
              onClick: handleLogout,
              style: { marginTop: '0.5rem' },
            },
            'Log out'
          ),
          React.createElement('p', { className: 'status' }, status)
        );

        const vaultListPanel = React.createElement(
          'div',
          { className: 'panel' },
          React.createElement('h2', null, 'Vaults'),
          vaults.length
            ? React.createElement(
                'div',
                { className: 'vault-list' },
                vaults.map((vault) =>
                  React.createElement(
                    'div',
                    {
                      key: vault.id,
                      className: `vault-card ${selected?.id === vault.id ? 'active' : ''}`,
                      onClick: () => selectVault(vault.id),
                    },
                    React.createElement('strong', null, vault.name || vault.id),
                    React.createElement('div', null, `${vault.role} • ${vault.status}`)
                  )
                )
              )
            : React.createElement('p', null, 'No shared vaults yet.')
        );

        const createPanel = React.createElement(
          'div',
          { className: 'panel' },
          React.createElement('h2', null, 'Create Shared Vault'),
          React.createElement('label', null, 'Name'),
          React.createElement('input', {
            placeholder: 'e.g. Team vault',
            value: name,
            onChange: (event) => setName(event.target.value),
          }),
          React.createElement('div', { className: 'member-grid' }, members.map((member, idx) =>
            React.createElement(
              'div',
              { key: idx },
              React.createElement('label', null, `Member ${idx + 1}`),
              React.createElement('input', {
                placeholder: 'User ID / username',
                value: member.userId,
                onChange: (event) => updateMember(idx, 'userId', event.target.value),
              }),
              React.createElement('select', {
                value: member.role,
                onChange: (event) => updateMember(idx, 'role', event.target.value),
              },
                React.createElement('option', { value: 'member' }, 'Member (edit)'),
                React.createElement('option', { value: 'viewer' }, 'Viewer (read-only)')
              )
            )
          )),
          React.createElement('button', { onClick: addMember, className: 'secondary' }, 'Add another member'),
          React.createElement('div', { style: { marginTop: '0.75rem' } },
            React.createElement('button', { onClick: createVault }, 'Create vault')
          )
        );

        const isOwner = selected?.ownerId === sessionUserId;
        const selectedPanel = selected
          ? React.createElement(
              'div',
              { className: 'panel' },
              React.createElement('h2', null, 'Selected Vault'),
              React.createElement('p', null, `Name: ${selected.name}`),
              React.createElement('p', null, `Version: ${selected.version || 0}`),
              React.createElement('p', null, `State: ${selected.memberKeys ? 'Loaded' : '—'}`),
              React.createElement(
                'div',
                { className: 'members' },
                (selected.members || []).map((member) =>
                  React.createElement(
                    'span',
                    {
                      key: member.identifier ?? member.userId,
                      className: `member-chip ${member.role === 'viewer' ? 'viewer' : ''}`,
                    },
                    `${member.identifier ?? member.userId ?? 'unknown'} (${member.role})`
                  )
                )
              ),
              isOwner &&
                React.createElement(
                  'div',
                  { style: { display: 'flex', gap: '0.5rem', marginTop: '0.75rem' } },
                  React.createElement(
                    'button',
                    {
                      type: 'button',
                      onClick: () => setIsEditingVault(!isEditingVault),
                      className: 'secondary',
                    },
                    isEditingVault ? 'Cancel edit' : 'Edit vault'
                  ),
                  React.createElement(
                    'button',
                    {
                      type: 'button',
                      onClick: handleDeleteVault,
                      className: 'secondary',
                      style: { borderColor: 'rgba(248, 113, 113, 0.6)', color: '#fecaca' },
                    },
                    'Delete vault'
                  )
                )
            )
          : null;

        const editorPanel =
          selected && isOwner && isEditingVault
            ? React.createElement(
                'div',
                { className: 'panel' },
                React.createElement('h2', null, 'Edit shared vault'),
                React.createElement('label', null, 'Name'),
                React.createElement('input', {
                  value: editName,
                  onChange: (event) => setEditName(event.target.value),
                }),
                React.createElement('div', { className: 'member-grid' }, editMembers.map((member, idx) =>
                  React.createElement(
                    'div',
                    { key: idx, style: { display: 'grid', gap: '0.3rem', marginBottom: '0.4rem' } },
                    React.createElement('label', null, `Member ${idx + 1}`),
                    React.createElement('input', {
                      placeholder: 'User ID / username',
                      value: member.identifier,
                      onChange: (event) => updateEditMember(idx, 'identifier', event.target.value),
                    }),
                    React.createElement(
                      'select',
                      {
                        value: member.role,
                        onChange: (event) => updateEditMember(idx, 'role', event.target.value),
                        disabled: member.role === 'owner',
                      },
                      React.createElement('option', { value: 'owner' }, 'Owner'),
                      React.createElement('option', { value: 'admin' }, 'Admin'),
                      React.createElement('option', { value: 'member' }, 'Member (edit)'),
                      React.createElement('option', { value: 'viewer' }, 'Viewer (read-only)')
                    ),
                    member.role !== 'owner' &&
                      React.createElement('button', {
                        type: 'button',
                        onClick: () => removeEditMember(idx),
                        className: 'secondary',
                        style: { borderColor: 'rgba(248, 113, 113, 0.6)', color: '#fecaca' },
                      }, 'Remove')
                  )
                )),
                React.createElement('button', { onClick: addEditMember, className: 'secondary' }, 'Add another member'),
                React.createElement(
                  'div',
                  { style: { display: 'flex', gap: '0.5rem', marginTop: '1rem' } },
                  React.createElement('button', { onClick: handleSaveVaultChanges, className: 'primary' }, 'Save changes'),
                  React.createElement('button', { onClick: () => setIsEditingVault(false), className: 'secondary' }, 'Close')
                )
              )
            : null;

        const secretDescription = msClientSecretSet
          ? 'A client secret is stored. Leave this blank to keep it, or use Reset / Clear secret to remove it.'
          : 'No client secret stored. Provide one if your Azure app requires it.';
        const usersPanel = React.createElement(
          'div',
          { className: 'panel' },
          React.createElement('h2', null, 'Registered users'),
          usersLoading && React.createElement('p', null, 'Loading users…'),
          usersError && React.createElement('p', { className: 'status' }, usersError),
          usersList.length
            ? React.createElement(
                'div',
                { className: 'user-table' },
                React.createElement(
                  'div',
                  { className: 'user-row user-row-header' },
                  React.createElement('span', null, 'Username'),
                  React.createElement('span', null, 'User ID'),
                  React.createElement('span', null, 'Last login')
                ),
                usersList.map((user) =>
                  React.createElement(
                    'div',
                    { key: user.id, className: 'user-row' },
                    React.createElement('span', null, user.username ?? '—'),
                    React.createElement('span', null, user.id),
                    React.createElement('span', null, user.lastLogin ?? 'Never')
                  )
                )
              )
            : React.createElement('p', null, 'No users yet.')
        );

        const auditPanel = React.createElement(
          'div',
          { className: 'panel' },
          React.createElement('h2', null, 'Audit log'),
          auditLoading && React.createElement('p', null, 'Loading audit entries…'),
          auditError && React.createElement('p', { className: 'status' }, auditError),
          auditEntries.length
            ? React.createElement(
                'div',
                { className: 'audit-table' },
                React.createElement(
                  'div',
                  { className: 'audit-row audit-row-header' },
                  React.createElement('span', null, 'Action'),
                  React.createElement('span', null, 'User'),
                  React.createElement('span', null, 'Timestamp'),
                  React.createElement('span', null, 'Details')
                ),
                auditEntries.map((entry) => {
                  const timestamp = entry.timestamp
                    ? new Date(entry.timestamp).toLocaleString()
                    : '—';
                  const detailText =
                    entry.details && Object.keys(entry.details).length
                      ? JSON.stringify(entry.details)
                      : '—';
                  return React.createElement(
                    'div',
                    { key: entry.id, className: 'audit-row' },
                    React.createElement('span', null, (entry.action ?? '—').replace(/_/g, ' ')),
                    React.createElement('span', null, entry.username ?? entry.userId ?? 'system'),
                    React.createElement('span', null, timestamp),
                    React.createElement('span', null, detailText)
                  );
                })
              )
            : !auditLoading && React.createElement('p', null, 'No audit entries yet.')
        );

        const ssoSettingsPanel = React.createElement(
          'div',
          { className: 'panel sso-panel' },
          React.createElement('h2', null, 'Microsoft SSO configuration'),
          React.createElement('label', null, 'Azure application (client) ID'),
          React.createElement('input', {
            placeholder: 'Application (client) ID',
            value: msClientId,
            onChange: (event) => setMsClientId(event.target.value),
          }),
          React.createElement('label', null, 'Tenant ID (leave blank for "common")'),
          React.createElement('input', {
            placeholder: 'common',
            value: msTenantId,
            onChange: (event) => setMsTenantId(event.target.value),
          }),
          React.createElement('label', null, 'Client secret (optional)'),
          React.createElement('input', {
            type: 'password',
            placeholder: msClientSecretSet
              ? 'Stored secret (leave blank to keep)'
              : 'Enter client secret',
            value: msClientSecret,
            onChange: (event) => setMsClientSecret(event.target.value),
          }),
          React.createElement(
            'div',
            { style: { display: 'flex', gap: '0.5rem', marginTop: '0.75rem', flexWrap: 'wrap' } },
            React.createElement('button', { onClick: handleSaveConfig, className: 'primary' }, 'Save settings'),
            React.createElement('button', { onClick: handleResetConfig, className: 'secondary' }, 'Reset'),
            React.createElement(
              'button',
              {
                onClick: handleClearSecret,
                className: 'secondary',
                disabled: !msClientSecretSet,
                style: { borderColor: 'rgba(248, 113, 113, 0.6)', color: '#fecaca' },
              },
              'Clear secret'
            )
          ),
          React.createElement('p', { className: 'status' }, secretDescription)
        );

        const managerPanels = React.createElement(
          React.Fragment,
          null,
          sessionPanel,
          vaultListPanel,
          createPanel,
          selectedPanel,
          editorPanel
        );

        const loginPanel = React.createElement(
          'div',
          { className: 'panel' },
          React.createElement('h1', null, 'Shared Vaults'),
          React.createElement(
            'p',
            null,
            'Log in to manage shared vaults and access the SSO settings.'
          ),
          React.createElement('label', null, 'Username'),
          React.createElement('input', {
            placeholder: 'Your username',
            value: loginUsername,
            onChange: (event) => setLoginUsername(event.target.value),
          }),
          React.createElement('label', null, 'Password'),
          React.createElement('input', {
            type: 'password',
            placeholder: 'Your password',
            value: loginPassword,
            onChange: (event) => setLoginPassword(event.target.value),
          }),
          React.createElement(
            'button',
            {
              type: 'button',
              onClick: handleLogin,
              disabled: loginLoading,
            },
            loginLoading ? 'Logging in…' : 'Log in'
          ),
          React.createElement(
            'button',
            {
              type: 'button',
              onClick: startMsSso,
              className: 'secondary',
              disabled: !msClientId.trim(),
              style: { marginTop: '0.6rem' },
            },
            'Sign in with Microsoft'
          ),
          React.createElement('p', { className: 'status' }, status)
        );

        const primaryColumn = token ? managerPanels : loginPanel;

        const ssoPlaceholder = React.createElement(
          'div',
          { className: 'admin-placeholder' },
          'Sign in to access Microsoft SSO settings.'
        );
        const usersPlaceholder = React.createElement(
          'div',
          { className: 'admin-placeholder' },
          'Sign in to view registered users.'
        );
        const auditPlaceholder = React.createElement(
          'div',
          { className: 'admin-placeholder' },
          'Sign in to view the audit log.'
        );

        let mainContent;
        if (activeSection === 'vault') {
          mainContent = token ? managerPanels : loginPanel;
        } else if (activeSection === 'sso') {
          mainContent = token ? ssoSettingsPanel : ssoPlaceholder;
        } else if (activeSection === 'users') {
          mainContent = token ? usersPanel : usersPlaceholder;
        } else {
          mainContent = token ? auditPanel : auditPlaceholder;
        }

        return React.createElement(
          'div',
          { className: 'admin-layout' },
          React.createElement(
            'div',
            { className: 'admin-inner' },
            React.createElement(
              'nav',
              { className: 'side-nav' },
              React.createElement(
                'button',
                {
                  className: `nav-btn ${activeSection === 'vault' ? 'active' : ''}`,
                  type: 'button',
                  onClick: () => setActiveSection('vault'),
                },
                'Vault Manager'
              ),
              React.createElement(
                'button',
                {
                  className: `nav-btn ${activeSection === 'sso' ? 'active' : ''}`,
                  type: 'button',
                  onClick: () => setActiveSection('sso'),
                  disabled: !token,
                },
                'Microsoft SSO settings'
              )
              ,
              React.createElement(
                'button',
                {
                  className: `nav-btn ${activeSection === 'users' ? 'active' : ''}`,
                  type: 'button',
                  onClick: () => setActiveSection('users'),
                  disabled: !token,
                },
                'Users'
              )
              ,
              React.createElement(
                'button',
                {
                  className: `nav-btn ${activeSection === 'audit' ? 'active' : ''}`,
                  type: 'button',
                  onClick: () => setActiveSection('audit'),
                  disabled: !token,
                },
                'Audit log'
              )
            ),
            React.createElement('div', { className: 'admin-main' }, mainContent)
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
